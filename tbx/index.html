<!DOCTYPE html>
<html>
<head>
<style>
textarea {
}
</style>
</head>
<body>

<h1>Component Transpiler to Python</h1>

<!-- <p>source snippet:</p> -->
<!-- <textarea id="src" rows="7" cols="90" placeholder="src" style="background-color:oldlace;"> -->
<!-- signature ≈❲ls❳ { -->
<!--   inputs {➢❲directory❳ ➢❲iterate❳} -->
<!--   outputs {◦❲filename❳} -->
<!-- } -->

<!-- implementation ≈❲ls❳ leaf { -->
<!--   on ➢❲directory❳ {callproc č❲a❳} -->
<!--   on ➢❲iterate❳ {callproc č❲b❳} -->

<!-- proc č❲a❳ { -->
<!--   ⟪self.dirname = message.data⟫ -->
<!-- } -->
<!-- proc č❲b❳ { -->
<!--   ⟪ -->
<!-- files = os.listdir (self.dirname) -->
<!-- for fname in files: -->
<!--     name = self.dirname + '/' + fname -->
<!--     if (os.path.isfile (name)): -->
<!--         self.send (self, 'filename', name, message) -->
<!--     else: -->
<!--         pass -->
<!--   ⟫ -->
<!-- } -->

<!-- } -->
<!-- </textarea> -->

<!-- <p>source:</p> -->
<!-- <textarea id="src" rows="7" cols="90" placeholder="src" style="background-color:oldlace;"> -->
<!-- signature ≈❲Copy Script❳ { -->
<!--   inputs {➢❲start❳ ➢❲done₁❳ ➢❲done₂❳ ➢❲done₃❳ ➢❲done₄❳} -->
<!--   outputs { -->
<!--     ◦❲step₁❳ ◦❲notify₁❳ -->
<!--     ◦❲step₂❳ ◦❲notify₂❳ -->
<!--     ◦❲step₃❳ ◦❲notify₃❳ -->
<!--     ◦❲step₄❳ ◦❲notify₄❳ -->
<!--     ◦❲done❳ -->
<!--   } -->
<!-- } -->

<!-- implementation ≈❲Copy Script❳ machine { -->
<!--  start ą❲idle❳ -->

<!--  state ą❲idle❳ { -->
<!--    on ➢❲start❳ { -->
<!--      callproc č❲a❳ -->
<!--    } -->
<!--  } -->

<!--  state ą❲step 1❳ { -->
<!--    on ➢❲done₁❳ { -->
<!--      callproc č❲b❳ -->
<!--    } -->
<!--  } -->

<!--  state ą❲step 2❳ { -->
<!--    on ➢❲done₂❳ { -->
<!--      callproc č❲c❳ -->
<!--    } -->
<!--  } -->

<!--  state ą❲step 3❳ { -->
<!--    on ➢❲done₃❳ { -->
<!--      callproc č❲d❳ -->
<!--    } -->
<!--  } -->

<!--  state ą❲step 4❳ { -->
<!--    on ➢❲done₄❳ { -->
<!--      callproc č❲e❳ -->
<!--    } -->
<!--  } -->


<!-- proc č❲a❳ { -->
<!--   ⟪send (self, 'step₁', True, message)⟫ -->
<!--   ⟪send (self, 'notify₁', True, message)⟫ -->
<!-- } -->
<!-- proc č❲b❳ { -->
<!--   ⟪send (self, 'step₂', True, message)⟫ -->
<!--   ⟪send (self, 'notify₂', True, message)⟫ -->
<!-- } -->
<!-- proc č❲c❳ { -->
<!--   ⟪send (self, 'step₃', True, message)⟫ -->
<!--   ⟪send (self, 'notify₃', True, message)⟫ -->
<!-- } -->
<!-- proc č❲d❳ { -->
<!--   ⟪send (self, 'step₄', True, message)⟫ -->
<!--   ⟪send (self, 'notify₄', True, message)⟫ -->
<!-- } -->
<!-- proc č❲e❳ { -->
<!--   ⟪send (self, 'done', True, message)⟫ -->
<!-- } -->


<!-- } -->
<!-- </textarea> -->

<!-- <p>source:</p> -->
<!-- <textarea id="src" rows="7" cols="90" placeholder="src" style="background-color:oldlace;"> -->
<!-- signature ≈❲Copy Script❳ { -->
<!--   inputs {➢❲start❳} -->
<!--   outputs {} -->
<!-- } -->

<!-- implementation ≈❲Copy Script❳ container { -->
<!--   constants { -->
<!--     įs❲out.test.md❳ 'out.test.md' -->
<!--     įs❲test.md❳ 'test.md' -->
<!--     įs❲/Users/tarvydas/Dropbox/ps❳ '/Users/tarvydas/Dropbox/ps' -->
<!--     įs❲.md❳ '.md' -->
<!--     įs❲manuscript❳ 'manuscript' -->
<!--     įs❲manuscript/resources❳ 'manuscript/resources' -->
<!--     įs❲pngfixed-❳ 'pngfixed-' -->
<!--     įs❲mdfixed-❳ 'mdfixed-' -->
<!--   } -->
  
<!--   initially { -->
<!--     š įs❲out.test.md❳                ⇨ ū❲n1❳   -->
<!--     š įs❲test.md❳                    ⇨ ū❲n2❳   -->
<!--     š įs❲/Users/tarvydas/Dropbox/ps❳ ⇨ ū❲n3❳   -->
<!--     š įs❲.md❳                        ⇨ ū❲n4❳   -->
<!--     š įs❲manuscript❳                 ⇨ ū❲n5❳   -->
<!--     š įs❲manuscript/resources❳       ⇨ ū❲n6❳ -->
<!--     š įs❲pngfixed-❳                  ⇨ ū❲n19❳   -->
<!--     š įs❲mdfixed-❳                   ⇨ ū❲n20❳ -->
<!--   } -->

<!--   children { -->
<!--     ž❲Script Sequencer❳ ≈❲Script Sequencer❳ -->
<!--     ž❲Generate Links File❳ ≈❲Generate Links File❳ -->
<!--     ž❲CopierWrapper❳ ≈❲Copier Wrapper❳  -->
<!--     ž❲Fixup PNG Wrapper❳ ≈❲Fixup PNG Wrapper❳ -->
<!--     ž❲Fixup MD Wrapper❳ ≈❲Fixup MD Wrapper❳ -->
<!--   } -->
  
<!--   nets { -->
<!--     ū❲n1❳ ū❲n2❳ ū❲n3❳ ū❲n4❳ ū❲n5❳ ū❲n6❳ ū❲n7❳ ū❲n8❳ ū❲n9❳ ū❲n10❳ -->
<!--     ū❲n11❳ ū❲n12❳ ū❲n13❳ ū❲n14❳ ū❲n15❳ ū❲n16❳ ū❲n17❳ ū❲n18❳ -->
<!--     ū❲n19❳ ū❲n20❳ -->
<!--     ū❲n21❳ -->
<!--   } -->
  
<!--   senders { -->
<!--     š ➢❲start❳                           ⇨ ū❲n21❳ -->

<!--     ž❲Script Sequencer❳ ◦❲step 1❳        ⇨ ū❲n7❳   -->
<!--     ž❲Script Sequencer❳ ◦❲step 1 notify❳ ⇨ ū❲n8❳   -->

<!--     ž❲Script Sequencer❳ ◦❲step 2❳        ⇨ ū❲n10❳   -->
<!--     ž❲Script Sequencer❳ ◦❲step 2 notify❳ ⇨ ū❲n11❳   -->

<!--     ž❲Script Sequencer❳ ◦❲step 3❳        ⇨ ū❲n13❳   -->
<!--     ž❲Script Sequencer❳ ◦❲step 3 notify❳ ⇨ ū❲n14❳   -->

<!--     ž❲Script Sequencer❳ ◦❲step 4❳        ⇨ ū❲n16❳   -->
<!--     ž❲Script Sequencer❳ ◦❲step 4 notify❳ ⇨ ū❲n17❳   -->
<!--   } -->
  
<!--   receivers { -->
<!--     ū❲n1❳  ⇨ {ž❲Copier Wrapper❳ ➢❲filename❳} -->
<!--     ū❲n2❳  ⇨ {ž❲Generate Links File❳ ➢❲filename❳} -->
<!--     ū❲n3❳  ⇨ {ž❲Generate Links File❳ ➢❲base directory❳} -->
<!--     ū❲n4❳  ⇨ {ž❲Generate Links File❳ ➢❲suffix❳} -->
<!--     ū❲n5❳  ⇨ {ž❲Copier Wrapper❳ ➢❲md destination directory❳ -->
<!--                ž❲Fixup MD Wrapper❳ ➢❲md destination directory❳} -->
<!--     ū❲n6❳  ⇨ {ž❲Copier Wrapper❳ ➢❲png destination directory❳ -->
<!--                ž❲Fixup PNG Wrapper❳ ➢❲png destination directory❳} -->
<!--     ū❲n9❳  ⇨ {ž❲Script Sequencer❳ ➢❲done step 1❳} -->
<!--     ū❲n12❳ ⇨ {ž❲Script Sequencer❳ ➢❲done step 2❳} -->
<!--     ū❲n15❳ ⇨ {ž❲Script Sequencer❳ ➢❲done step 3❳} -->
<!--     ū❲n18❳ ⇨ {ž❲Script Sequencer❳ ➢❲done step 4❳} -->
<!--     ū❲n19❳ ⇨ {ž❲Fixup PNG Wrapper❳ ➢❲png fixed prefix❳} -->
<!--     ū❲n20❳ ⇨ {ž❲Fixup MD Wrapper❳ ➢❲md fixed prefix❳} -->
<!--   } -->
  
<!-- } -->
<!-- </textarea> -->

<p>source:</p>
<textarea id="src" rows="7" cols="90" placeholder="src" style="background-color:oldlace;">
signature ≈❲Omit Comments❳ {
  inputs {➢❲text❳}
  outputs {◦❲text❳}
}

implementation ≈❲Omit Comments❳ leaf {
  on ➢❲text❳ {callproc č❲a❳}

  proc č❲a❳ {
⟪
result = re.sub (r'\#.*\n', '\n', message.data)
self.send (self, 'text', result, message)
⟫
  }
}
</textarea>


<p>output:</p>
<textarea id="output" rows="15" cols="60" placeholder="transpiled"  readonly style="background-color:whitesmoke;">
</textarea>
<!-- <textarea id="temp" rows="15" cols="50" placeholder="transpiled"  readonly style="background-color:whitesmoke;"> -->
<!-- </textarea> -->
<br>
<br>
<p id="status" > READY </p>
<br>
<button onclick="transpile ()">Test</button>
<!-- Ohm-JS -->
<script src="https://unpkg.com/ohm-js@16/dist/ohm.min.js"></script>


<!-- Macro preprocessor -->
<script src="../../nl/mac.js"></script>


<script>
  function fixup (s) {
      return s
          .replace (/~{/g, '${');
  }

  const grammar = String.raw`
Operand {
topLevel = any

oExplicitInput = "➢" name
oImplicitInput = "➢" implicitIndicator name

oExplicitOutput = "◦" name
oImplicitOutput = "◦" implicitIndicator name

implicitIndicator = "y"


oFunction = "ė" name
oProcedure = "č" name
oChild = "ž" name
oPrototype = "≈" name
oSelf = "š"
oString = "įs" name
oNumber = "įn" name
oNet = "ū" name
oState = "ą" name


oVerbatim = "⟪" verbatimBody* "⟫"
verbatimBody =
  | "⟪" verbatimBody "⟫" -- rec
  | ~"⟪" ~"⟫" any        -- bottom
oVerbatimFunction = "⟪" verbatimFunctionBody* "⟫?"
verbatimFunctionBody =
  | "⟪" (verbatimBody | verbatimFunctionBody) "⟫?" -- rec
  | ~"⟪" ~"⟫" any                                  -- bottom

oStringLiteral = 
  | dq notDQ* dq
  | sq notSQ* sq
oNumberLiteral =
  | digit+      -- decimal
  | "0x" hexDigit+     -- hex
  | "0b" binaryDigit+  -- binary

binaryDigit = "0" .. "1"


name = "❲" nameChar+ "❳"
nameChar =
  | ~"❲" ~"❳" any

dq = "\""
sq = "'"
notDQ = escapedChar | (~dq any)
notSQ = escapedChar | (~sq any)
escapedChar = backslash any
backslash = "\\"
}

Signature <: Operand {
Signature = 
  "signature" oPrototype "{" 
    "inputs" "{" oExplicitInput* "}"
    "outputs" "{" oExplicitOutput* "}"
  "}"
}

Routine <: Signature {
Proc = "proc" oProcedure StatementBlock
StatementBlock = "{" Statement+ "}"
Statement =
  | oVerbatim -- verbatim
  | "callproc" oProcedure -- callproc
Func = "func" oFunction "{" Expression+ "}"
Expression =
  | oVerbatimFunction -- verbatim
  | "callfunc" oFunction -- callfunc
  | oString -- stringliteral
  | oNumber -- numberliteral
}





Component <: Routine {
topLevel := applySyntactic<TopLevel>
TopLevel = (Signature | MachineDeclaration | ContainerDeclaration | LeafDeclaration)*

MachineDeclaration = "implementation" oPrototype "machine" "{" MachineInnards "}"
MachineInnards = StartState State+ Proc*
StartState = "start" oState
State = "state" oState "{" StateInnard+ "}"
StateInnard =
  | Entry
  | Exit
  | Transition
Entry = "enter" StatementBlock
Exit = "exit" StatementBlock
Transition = Handler

LeafDeclaration = "implementation" oPrototype "leaf" "{" Handler+ Proc* "}"
Handler = "on" oExplicitInput StatementBlock

ContainerDeclaration = "implementation" oPrototype "container" "{" Constants Initially Children Nets Senders Receivers "}"
Constants = "constants" "{" ConstantInitializer* "}"
ConstantInitializer =
  | oString oStringLiteral -- string
  | oNumber oNumberLiteral -- number
Initially = "initially" "{" SendConstant* "}"
Children = "children" "{" ChildDeclaration* "}"
Nets = "nets" "{" oNet* "}"
Senders = "senders" "{" Sender* "}"
Receivers = "receivers" "{" ReceiverList* "}"

ChildDeclaration = oChild oPrototype

Sender =
  | SendInput
  | SendOutput
ReceiverList = oNet MessageArrow "{" Receiver+ "}"
Receiver =
  | ReceiveInput
  | ReceiveOutput

SendConstant = oSelf (oString | oNumber) MessageArrow oNet
SendInput = oSelf oExplicitInput MessageArrow oNet
SendOutput = oChild oExplicitOutput MessageArrow oNet
MessageArrow = "⇨"

ReceiveInput = oChild oExplicitInput
ReceiveOutput = oSelf oExplicitOutput
}
`;

  const fmt = String.raw`
oExplicitInput [k name] = [[~{name}]]
oImplicitInput [k i name] = [[~{k}~{i}~{name}]]

oExplicitOutput [k name] = [[~{name}]]
oImplicitOutput [k i name] = [[~{k}~{i}~{name}]]

implicitIndicator [c] = [[~{c}]]


oFunction [k name] = [[~{name}]]
oProcedure [k name] = [[~{name}]]
oChild [k name] = [[~{name}]]
oPrototype [k name] = [[~{name}]]
oSelf [k] = [[self]]
oString [k name] = [[~{name}]]
oNumber [k name] = [[~{name}]]
oNet [k name] = [[~{name}]]
oState [k name] = [[~{name}]]


oVerbatim [lb @body rb] = [[~{body}]]
verbatimBody_rec [ lb verbatimBody rb] = [[~{verbatimBody}]]
verbatimBody_bottom [c] = [[~{c}]]

oVerbatimFunction [lb @body rb] = [[~{body}]]
verbatimFunctionBody_rec [ lb verbatimBody rb] = [[~{verbatimBody}]]
verbatimFunctionBody_bottom [c] = [[~{c}]]

oStringLiteral [lq @cs rq] = [[~{lq}~{cs}~{rq}]]

oNumberLiteral_decimal [@ds] = [[~{ds}]]
oNumberLiteral_hex [k @ds] = [[~{k}~{ds}]]
oNumberLiteral_binary [k @ds] = [[~{k}~{ds}]]

binaryDigit [c] = [[~{c}]]

name [lb @cs rb] = [[~{PYNAME(cs)}]]
nameChar [c] = [[~{c}]]

dq [c] = [[~{c}]]
sq [c] = [[~{c}]]
notDQ [x] = [[~{x}]]
notSQ [x] = [[~{x}]]
escapedChar [kbackslash any] = [[~{backslash}~{any}]]
backslash [c] = [[~{c}]]

Signature [ksignature oPrototype klb kinputs klb2 @oExplicitInput krb2 koutputs klb3 @oExplicitOutput krb3 krb] = [[]]


Proc [kproc oProcedure StatementBlock] = 
{{ let hdr = '(.def ' + _oProcedure._glue () + ' ():'; }}
[[\n~{hdr}~{StatementBlock}.)]]

StatementBlock [lb @Statement rb] = [[~{Statement}]]
Statement_verbatim [x] = [[~{x}]]
Statement_callproc [k x] = [[self.~{x} ()]]

Func [kfunc oFunction lb @Expression rb] = [[~{kfunc}~{oFunction}~{lb}~{Expression}~{rb}]]
Expression_verbatim [x] = [[~{x}]]
Expression_callfunc [k x] = [[~{k}~{x}]]
Expression_stringliteral [x] = [[~{x}]]
Expression_numberliteral [x] = [[~{x}]]






topLevel [x] = [[~{x}]]
TopLevel [@x] = [[~{x}]]

MachineDeclaration [kimplementation oPrototype kmachine lb MachineInnards rb] =
  [[~{kimplementation}~{oPrototype}~{kmachine}~{lb}~{MachineInnards}~{rb}]]
MachineInnards [StartState @State @Proc] = [[~{StartState}~{State}~{Proc}]]
StartState [kstart oState] = [[~{kstart}~{oState}]]
State [kstate oState lb @StateInnard rb] = [[~{kstate}~{oState}~{lb}~{StateInnard}~{rb}]]
StateInnard [x] = [[~{x}]]

Entry [kenter StatementBlock] = [[~{kenter}~{StatementBlock}]]
Exit [kexit StatementBlock] = [[~{kexit}~{StatementBlock}]]
Transition [Handler] = [[~{Handler}]]

LeafDeclaration [kimplementation oPrototype kleaf lb @Handler @Proc rb] = 
[[(.class ~{oPrototype} (Leaf):
(.def __init__ (self, parent, name):
(.super().__init__ (parent, name).).)~{Proc}~{dumphandlers ()}
.)]]

Handler [kon oExplicitInput StatementBlock] = [[
~{handlerappend ("\nelif (message.port == '" + oExplicitInput + "'):(.\n" + _StatementBlock._glue ()) + "\n.)"}]]

ContainerDeclaration [kimplementation oPrototype kcontainer lb Constants Initially Children Nets Senders Receivers rb] =
  [[~{kimplementation}~{oPrototype}~{kcontainer}~{lb}~{Constants}~{Initially}~{Children}~{Nets}~{Senders}~{Receivers}~{rb}]]
Constants [kconstants lb @ConstantInitializer rb] = [[~{kconstants}~{lb}~{ConstantInitializer}~{rb}]]
ConstantInitializer_string [name lit] = [[~{name}~{lit}]]
ConstantInitializer_number [name lit] = [[~{name}~{lit}]]

Initially [kinitially lb @SendConstant rb] = [[~{kinitially}~{lb}~{SendConstant}~{rb}]]
Children [k lb @decl rb] = [[~{k}~{lb}~{decl}~{rb}]]
Nets [k lb @decl rb] = [[~{k}~{lb}~{decl}~{rb}]]
Senders [k lb @decl rb] = [[~{k}~{lb}~{decl}~{rb}]]
Receivers [k lb @decl rb] = [[~{k}~{lb}~{decl}~{rb}]]

ChildDeclaration [oChild oPrototype] = [[~{oChild}~{oPrototype}]]

Sender [s] = [[~{s}]]

ReceiverList [oNet MessageArrow lb @Receiver rb] = [[~{oNet}~{MessageArrow}~{lb}~{Receiver}~{rb}]]
Receiver [r] = [[~{r}]]

SendConstant [oSelf x MessageArrow oNet] = [[~{oSelf}~{x}~{MessageArrow}~{oNet}]]
SendInput [oSelf x MessageArrow oNet] = [[~{oSelf}~{x}~{MessageArrow}~{oNet}]]
SendOutput [oSelf x MessageArrow oNet] = [[~{oSelf}~{x}~{MessageArrow}~{oNet}]]
MessageArrow [c] = [[~{c}]]

ReceiveInput [oChild oExplicitInput] = [[~{oChild}~{oExplicitInput}]]
ReceiveOutput [oSelf oExplicitOutput] = [[~{oSelf}~{oExplicitOutput}]]


`;

  function transpile1 (src, grammar, fmt, message) {
      var success = false;
      var transpiled = '';
      var jssemantics = '';
      try {
          [success, transpiled, jssemantics] = expand1 (src, grammar, fmt, fixup, 'Component');
      } catch (err) {
          success = false;
      }
      if (success) {
          return [true, transpiled];
      } else {
          document.getElementById('status').innerHTML = "FAILED " + message + "<br>" + Date ();
          return [false, transpiled];
      }
  }

  function transpile () {
      let src = document.getElementById('src').value;
      let [success, step] = transpile1 (src, grammar, fmt, "component identity step");
      if (success) {
          // // skip step2, the step2 identity transpiler was used for development of step3
          // let [success3, step3] = transpile1 (step1, nl2jsgrammar, nl2jsfmt, "transpilation step");
          // if (success3) {
          //     let [success4, step4] = transpile1 (step3, peepholegrammar, peepholefmt, "peephole step");
          //     if (success4) {
          document.getElementById('status').innerHTML = "OK " + Date ();
          //document.getElementById('temp').innerHTML = step;
          document.getElementById('output').innerHTML = indenter (step);
          //     }
          // }
      } else {
          document.getElementById('output').innerHTML = step;
      }
  }

  // support routines
  function PYNAME (s) {
      return s.replace (/ /g,'_');
  }
  // var indentstack = ['']
  // function IN () {
  //     var previousindent = indentstack.pop ();
  //     indentstack.push (previousindent);
  //     var newindent = '  ' + previousindent;
  //     indentstack.push (newindent);
  //     return '';
  // }
  // function OUT () {
  //     indentstack.pop ();
  //     return '';
  // }
  // function SP () {
  //     let indent = indentstack.pop ();
  //     indentstack.push (indent);
  //     return '\n' + indent;
  // }
  // function SPmore () {
  //     let indent = indentstack.pop ();
  //     indentstack.push (indent);
  //     return '\n' + indent + indent;
  // }
  // function PY (s) {
  //     let indent = indentstack.pop ();
  //     indentstack.push (indent);
  //     return s.replace (/\n/g, '\n' + indent);
  // }

  var handlercode = '';
  function handlerappend (s) {
      handlercode += s;
      return '';
  }

  function dumphandlers () {
      return "\n(.def handler (self, message):\nif (False):(.\npass.)" + handlercode + ".)";
  }
  
  var indentation = [];
  function indent1 (s) {
      var opens = (s.match (/\(\./g) || []).length;
      var closes = (s.match (/\.\)/g) || []).length;
      var r0 = s.trim ();
      var r1 = r0.replace (/\(\./g, '');
      var r2 = r1.replace (/\.\)/g, '');
      var spaces = indentation.join ('');
      var r  = spaces + r2.replace (/\n/g, spaces);
      var diff = opens - closes;
      if (diff > 0) {
	  while (diff > 0) {
	      indentation.push ('  ');
	      diff -=1;
	  }
      } else {
	  while (diff < 0) {
	      indentation.pop ();
	      diff += 1;
	  }
      }
      return r;
  }

  function indenter (str) {
      var result = '';
      str.split ('\n').forEach (line => {
	  var s = indent1 (line);
	  result += '\n' + s;
      });
      return result;
  }



  
  </script>
</body>
</html>


